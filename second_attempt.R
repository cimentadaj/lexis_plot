################################################################################
#                                                                              #                         
# Enhanced Lexis Diagram                                                       #                        
# Sebastian Kl?sener, MPIDR                                                    #  
#                                                                              #
################################################################################

# Erase all objects in workspace
rm(list=ls(all=TRUE))

# Code to install/update libraries on your computer 
# install.packages(c("spdep","rgdal","maptools","mapproj",
# "geosphere","classInt","RColorBrewer"))

# Load libraries
library(tidyverse)
library(lattice)
library(spdep)
library(rgdal)
library(maptools)
library(mapproj)
library(geosphere)
library(classInt)
library(RColorBrewer)
library(classInt)
library(viridis)
library(scales)
library(extrafont)


################################################################################
#                                                                              #
# 1) Import and prepare data                                                   #
#                                                                              #
################################################################################ 

# Load population data
pop <- read.table("Population_SWE.csv",sep=",",header=TRUE,na.strings = ".")
exp <- read.table("cExposures_1x1.csv",sep=",",header=TRUE,na.strings = ".")
cmx <- read.table("cMx_1x1.csv",sep=",",header=TRUE,na.strings = ".")

# Reshape into long format
pop_long <- reshape(pop, varying=names(pop)[c(3:5)],
                    v.names="Pop",times=names(pop)[c(3:5)],
                    timevar="Sex",direction="long")

# Define row names
row.names(pop_long) <- c(1:nrow(pop_long))

# Turn age into a numeric variable
pop_long$Age <- as.numeric(as.character(pop_long$Age))
pop_long$Age[is.na(pop_long$Age)] <- 110

# Subset dataset so that it only includes ages up to 100
pop_long <-subset(pop_long,pop_long$Age<=100,select=-id)
head(pop_long)

# Derive cohort data (Population on January 1st)
pop_long$Cohort <- pop_long$Year-pop_long$Age-1


choose <- c("Male","Female")
export <- c("MALES","FEMALES")
title <- c("Males","Females")

# Choose Male (1) of Female (2) 
ch <- 1

# Choose data from 1750 on
pop_ch <- pop_long[pop_long$Cohort > 1750 & pop_long$Sex==choose[ch], ]

# Derive the maximum size that was ever recorded for a cohort
# Split by cohort
bycoh <- split(pop_ch$Pop,pop_ch$Cohort)

# Derive maximum
maxcoh <- unlist(lapply(bycoh,max))
plot(as.numeric(names(maxcoh)),maxcoh,type="l",
     xlab="Maximum population size recorded for cohort",ylab="Cohort")

# Match maximum size information to cohort
o <- match(pop_ch$Cohort,names(maxcoh))
pop_ch$Maxpop <- maxcoh[o]

# Here I determine the linewidth for the upper lines
# This should be improved
factor <- 3
popstand <- pop_ch$Pop/max(pop_ch$Pop)*factor
lwd_up <- popstand

# Here I determine the linewidth for the lower lines
# This should be improved
popmax <- pop_ch$Maxpop/max(pop_ch$Pop)*factor
lcoh <- length(unique(pop_ch$Cohort))
cohmax <- maxcoh/max(pop_ch$Pop)*factor
lwd_low <- cohmax

# Match pop data to cmx data
# Turn age in cmx into a numeric variable
cmx$Age <- as.numeric(as.character(cmx$Age))
cmx$Age[is.na(cmx$Age)] <- 110


matchvecmx <- paste(c(cmx$Year+cmx$Age)+1,cmx$Age)
matchvecpop <- paste(pop_ch$Year,pop_ch$Age)

o1 <- match(matchvecpop,matchvecmx)
csex <- which(colnames(cmx)==choose[ch]) 

pop_ch$mx <- cmx[,csex][o1]


library(viridis)
library(classInt)
colpal <- magma(100, alpha = 1, begin = 0.1, end = 1)
# Choose bins
bins <- c(seq(0,0.05,0.05/50), seq(0.055,0.2,0.145/20),seq(0.2,1,0.8/28)[-1])
# Assigns color according to fixed breaks categorization 
catg <- classIntervals(pop_ch$mx, fixedBreaks=bins, 
                       style = "fixed")
color <- findColours(catg, colpal)

pop_ch$color <- color

color_matrix <-
  complete(pop_ch, Cohort, Age, fill = list(Pop = NA, Maxpop = NA, mx = NA, color = NA)) %>%
  select(Cohort, Age, color) %>%
  spread(Age, color) %>%
  as.matrix()

# Cohorts and ages
coh <- as.numeric(unique(color_matrix[,"Cohort"]))
ages <- as.numeric(attr(color_matrix, "dimnames")[[2]][-1])

# Loop over cohorts and ages
n_coh <- length(coh)
n_ages <- length(ages)

# Functions
# Polygon
shrink_fun <- function(x, shrink, x_value = TRUE) {
  
  if(x_value) {
    xman <- x
    xman[1] <- mean(x[1:2])-(x[2] - x[1])*(shrink/2)
    xman[2] <- mean(x[1:2])+(x[2] - x[1])*(shrink/2)
  } else {
    xman <- x
    xman[3] <- mean(x[3:4])-(x[4] - x[3])*(shrink/2)
    xman[4] <- mean(x[3:4])+(x[4] - x[3])*(shrink/2)
  }
  xman
}

# shrink <- 1 no shrinking
# shrink <- 0 just  line
# Defined this as a vector for each cohort
shrink <- seq(0.9,0,by=-0.008)

#tiff(file=paste("Shrink_test.tif"),width = 9600, height = 4800, res=300, 
#     compression="lzw")
plot(x = c(coh[1], coh[length(coh)]),
     y = c(ages[1], ages[length(ages)]),
     col="transparent",
     xlab="Year",
     ylab="Age")

# You sort of fixed the colors but you still need to figure out how to change
# the border color of the polygons and the first line of colors.

# Loop for cohorts 
for (i in 1:coh) {
  # In order to fixate point 2 which we are 
  # are not shrinking
  mid_x <- seq(coh[i],coh[i]+n_ages,1)
  mid_y <- c(0:n_ages-1)
  
  # Loop for ages
  for (j in 1:n_ages) {
    # Lower Lexis triangle
    x <- c(mid_x[j],mid_x[j]+1, mid_x[j]+1, mid_x[j]+1)
    y <- c(mid_y[j], mid_y[j], mid_y[j],mid_y[j]+1)

    x_sh <- shrink_fun(x, shrink[j])
    y_sh <- shrink_fun(y, shrink[j], x_value = F)

    polygon(x_sh, y_sh, lty=0,col=color_matrix[i, j], border = color_matrix[i, j])

    # Upper Lexis triangle year + 1
    x_inv <- c(x[2], x[2] , x[2] ,x[2] + (x[2] - x[1]))
    y_inv <- c(y[1],y[4],y[4],y[4])

    x_inv_sh <- shrink_fun(x_inv, shrink[j],x_value = F)
    y_inv_sh <- shrink_fun(y_inv, shrink[j])

    polygon(x_inv_sh, y_inv_sh, lty=0, col=color_matrix[i, j], border = color_matrix[i, j])
  }
}
